<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - H&B Importaciones</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="site-header">
        <div class="topbar">
            <div class="container topbar-content">
                <span>Lunes a Viernes 09:00 a 18:00 | S√°bados 09:00 a 13:00</span>
                <div class="spacer"></div>
                <span>Bienvenido a H&B Importaciones</span>
                <div class="spacer"></div>
                <a href="#" class="top-link"><span data-icon="location" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Ubicaci√≥n</a>
                <a href="#" class="top-link"><span data-icon="truck" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Rastrear pedido</a>
                <button class="top-link" onclick="openAdvisorsModal()" style="background:none;border:none;cursor:pointer;color:inherit;font:inherit;padding:0;margin:0"><span data-icon="users" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Asesores</button>
                <a href="store.html" class="top-link"><span data-icon="store" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Tienda</a>
                <a href="../auth/login.html" class="top-link" id="login-link"><span data-icon="user" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Mi Cuenta</a>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <div class="header-content">
                    <a class="brand" href="../../index.html">H&B<span class="web-badge">web</span></a>
                    <div class="search">
                        <span class="search-icon" data-icon="search" style="width:18px;height:18px"></span>
                        <input type="text" id="cart-search" placeholder="Buscar productos...">
                    </div>
                    <div class="header-icons">
                        <a href="#" class="icon-btn">
                            <img src="../../image/corazon.png" alt="Lista de deseos" class="icon-img" style="width:16px;height:16px">
                        </a>
                        <a href="cart.html" class="icon-btn">
                            <img src="../../image/carrito.png" alt="Carrito" class="icon-img" style="width:16px;height:16px">
                            <span class="badge" id="cart-count">0</span>
                            <span class="cart-total" id="cart-total">$0,00</span>
                        </a>
                        <span id="logout-container"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="checkout-container">
        <div class="container">
            <!-- Back Button -->
            <div class="checkout-header">
                <button class="btn secondary back-btn" onclick="goBack()">
                    <span>‚Üê</span>
                    <span>Seguir Comprando</span>
                </button>
                <h1>Finalizar Compra</h1>
            </div>

            <!-- Progress Bar -->
            <div class="checkout-progress">
                <div class="progress-step active">
                    <div class="step-number">1</div>
                    <span>Informaci√≥n</span>
                </div>
                <div class="progress-line active"></div>
                <div class="progress-step active">
                    <div class="step-number">2</div>
                    <span>Pago</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-number">3</div>
                    <span>Confirmaci√≥n</span>
                </div>
            </div>

            <div class="checkout-layout">
                <!-- Left Column - Forms -->
                <div class="checkout-forms">
                    <!-- Contact Information -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <h2>Informaci√≥n de Contacto</h2>
                        </div>
                        <div class="form-grid">
                            <div class="field">
                                <label>Email *</label>
                                <input type="email" id="customer-email" placeholder="tu@email.com" required>
                            </div>
                            <div class="field">
                                <label>Tel√©fono *</label>
                                <input type="tel" id="customer-phone" placeholder="+593 99 999 9999" required>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Information -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <h2>Informaci√≥n de Env√≠o</h2>
                        </div>
                        <div class="form-grid">
                            <div class="field full-width">
                                <label>Nombre Completo *</label>
                                <input type="text" id="shipping-name" placeholder="Juan P√©rez" required>
                            </div>
                            <div class="field">
                                <label>Provincia *</label>
                                <select id="shipping-province" required>
                                    <option value="">Seleccionar provincia</option>
                                    <option value="pichincha">Pichincha</option>
                                    <option value="guayas">Guayas</option>
                                    <option value="azuay">Azuay</option>
                                    <option value="manabi">Manab√≠</option>
                                    <option value="tungurahua">Tungurahua</option>
                                    <option value="el-oro">El Oro</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Ciudad *</label>
                                <input type="text" id="shipping-city" placeholder="Quito" required>
                            </div>
                            <div class="field full-width">
                                <label>Direcci√≥n *</label>
                                <input type="text" id="shipping-address" placeholder="Av. Amazonas y Rep√∫blica, Edificio XYZ" required>
                            </div>
                            <div class="field">
                                <label>C√≥digo Postal</label>
                                <input type="text" id="shipping-postal" placeholder="170150">
                            </div>
                            <div class="field">
                                <label>Referencia</label>
                                <input type="text" id="shipping-reference" placeholder="Cerca del banco">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="checkout-section">
                        
                        <!-- Bank Logos -->
                        <div class="bank-logos-section">
                            <h3>Bancos con los que trabajamos</h3>
                            <div class="bank-logos-grid">
                                <div class="bank-logo">
                                    <img src="../../image/Banco-Pichincha.png" alt="Banco Pichincha">
                                    <span>Banco Pichincha</span>
                                </div>
                                <div class="bank-logo">
                                    <img src="../../image/bancoGuayaquil.png" alt="Banco de Guayaquil">
                                    <span>Banco de Guayaquil</span>
                                </div>
                                <div class="bank-logo">
                                    <img src="../../image/BancoInternacional.png" alt="Banco Internacional">
                                    <span>Banco Internacional</span>
                                </div>
                                <div class="bank-logo">
                                    <img src="../../image/bancoPac√≠fico.png" alt="Banco del Pac√≠fico">
                                    <span>Banco del Pac√≠fico</span>
                                </div>
                            </div>
                            <div class="payment-info">
                                <p>Para completar tu pago, cont√°ctanos por WhatsApp para coordinar la transferencia bancaria.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Order Summary -->
                <div class="order-summary">
                    <div class="summary-card">
                        <h3>Resumen del Pedido</h3>
                        
                        <div id="checkout-items" class="checkout-items">
                            <!-- Items will be loaded here -->
                        </div>

                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="checkout-subtotal">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Env√≠o</span>
                            <span id="checkout-shipping">Gratis</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span id="checkout-total">$0.00</span>
                        </div>

                        <button class="btn brand checkout-btn" onclick="processOrder()">
                            Completar Pedido
                        </button>

                        <div class="delivery-info">
                            <div class="delivery-item">
                                <span class="delivery-icon">üöö</span>
                                <span>Realizamos entregas en Quito y a provincia</span>
                            </div>
                            <div class="delivery-item">
                                <span class="delivery-icon">‚è±Ô∏è</span>
                                <span>El tiempo de entrega depende del transporte de carga pesada</span>
                            </div>
                        </div>

                        <div class="security-info">
                            <span data-icon="shield" style="width:16px;height:16px"></span>
                            <span>Informaci√≥n segura y protegida</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <small>¬© <span id="year"></span> H&B Importaciones</small>
        </div>
    </footer>

    <script src="../../js/utils/data.js"></script>
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/utils/icons.js"></script>
    <script src="../../js/utils/ui.js"></script>
    <script src="../../js/utils/sticky-header.js"></script>
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Verificar sesi√≥n y actualizar UI
        const sessionData = localStorage.getItem('hb_session');
        if (sessionData) {
            try {
                const session = JSON.parse(sessionData);
                document.getElementById('login-link').style.display = 'none';
                document.getElementById('logout-container').innerHTML = `
                    <button class="btn icon logout" onclick="logout()" title="Cerrar sesi√≥n">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 6H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 16l4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18 12H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                `;
            } catch (e) {
                // Sesi√≥n inv√°lida, mantener login visible
            }
        }

        function logout() {
            localStorage.removeItem('hb_session');
            window.location.href = '../auth/login.html';
        }

        // ===== CHECKOUT FUNCTIONALITY =====
        function loadCheckoutItems() {
            const container = document.getElementById('checkout-items');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const totalEl = document.getElementById('checkout-total');
            
            const cart = window.StorageAPI ? window.StorageAPI.getCart() : [];
            const products = window.StorageAPI ? window.StorageAPI.getProducts() : [];
            
            if (cart.length === 0) {
                window.location.href = 'store.html';
                return;
            }

            // Expandir carrito con informaci√≥n de productos
            const expandedCart = cart.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return null;
                
                return {
                    id: item.productId,
                    productId: item.productId,
                    quantity: item.quantity,
                    name: product.name,
                    price: product.pricePublico || product.price || 0,
                    category: product.category,
                    image: product.image
                };
            }).filter(item => item !== null);

            let subtotal = 0;
            container.innerHTML = expandedCart.map(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                return `
                    <div class="checkout-item" data-product-id="${item.productId}">
                        <div class="item-image">
                            <img src="${item.image || 'https://via.placeholder.com/60x60?text=Producto'}" alt="${item.name}">
                            <span class="item-quantity">${item.quantity}</span>
                        </div>
                        <div class="item-details">
                            <h4>${item.name}</h4>
                            <p>${item.category || 'General'}</p>
                        </div>
                        <div class="item-price">
                            $${itemTotal.toFixed(2)}
                        </div>
                        <div class="item-actions">
                            <button class="btn-remove" onclick="removeFromCheckout('${item.productId}')" title="Eliminar producto">
                                √ó
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            totalEl.textContent = `$${subtotal.toFixed(2)}`;
        }

        function processOrder() {
            // Validar formulario
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const name = document.getElementById('shipping-name').value;
            const province = document.getElementById('shipping-province').value;
            const city = document.getElementById('shipping-city').value;
            const address = document.getElementById('shipping-address').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;

            if (!email || !phone || !name || !province || !city || !address) {
                if (window.Helpers && window.Helpers.showToast) {
                    window.Helpers.showToast('Por favor completa todos los campos obligatorios', 'warning');
                } else {
                    alert('Por favor completa todos los campos obligatorios');
                }
                return;
            }

            // No se requieren validaciones de tarjeta ya que se coordina por WhatsApp

            // Crear objeto del pedido
            const cart = window.StorageAPI ? window.StorageAPI.getCart() : [];
            const products = window.StorageAPI ? window.StorageAPI.getProducts() : [];
            
            // Expandir carrito con informaci√≥n de productos
            const expandedCart = cart.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return null;
                
                return {
                    id: item.productId,
                    productId: item.productId,
                    quantity: item.quantity,
                    name: product.name,
                    price: product.pricePublico || product.price || 0,
                    category: product.category,
                    image: product.image
                };
            }).filter(item => item !== null);
            
            const total = expandedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const order = {
                id: 'ORD-' + Date.now(),
                date: new Date().toISOString(),
                customer: { email, phone, name },
                shipping: { 
                    province, 
                    city, 
                    address, 
                    postal: document.getElementById('shipping-postal').value,
                    reference: document.getElementById('shipping-reference').value
                },
                payment: {
                    method: 'transferencia_bancaria',
                    status: 'pendiente_coordinacion'
                },
                items: expandedCart,
                total: total,
                status: 'pending'
            };

            // Guardar pedido usando StorageAPI
            if (window.StorageAPI) {
                const orders = window.StorageAPI.getOrders();
                orders.push(order);
                window.StorageAPI.setOrders(orders);
                
                // Limpiar carrito
                window.StorageAPI.clearCart();
            }

            // Mostrar confirmaci√≥n
            if (window.Helpers && window.Helpers.showToast) {
                window.Helpers.showToast('¬°Pago procesado exitosamente! Tu pedido ha sido confirmado.', 'success');
            }

            // Generar mensaje para WhatsApp
            const whatsappMessage = generateWhatsAppMessage(order);
            
            setTimeout(() => {
                if (confirm('¬øDeseas enviar los detalles del pedido por WhatsApp?')) {
                    window.open(`https://wa.me/593994846405?text=${encodeURIComponent(whatsappMessage)}`, '_blank');
                }
                window.location.href = 'store.html';
            }, 2000);
        }

        function generateWhatsAppMessage(order) {
            let message = `üõí *NUEVO PEDIDO - H&B Importaciones*\n\n`;
            message += `üìã *Pedido:* ${order.id}\n`;
            message += `üìÖ *Fecha:* ${new Date(order.date).toLocaleDateString()}\n\n`;
            
            message += `üë§ *Cliente:*\n`;
            message += `‚Ä¢ Nombre: ${order.customer.name}\n`;
            message += `‚Ä¢ Email: ${order.customer.email}\n`;
            message += `‚Ä¢ Tel√©fono: ${order.customer.phone}\n\n`;
            
            message += `üìç *Direcci√≥n de Env√≠o:*\n`;
            message += `‚Ä¢ ${order.shipping.address}\n`;
            message += `‚Ä¢ ${order.shipping.city}, ${order.shipping.province}\n`;
            if (order.shipping.reference) {
                message += `‚Ä¢ Referencia: ${order.shipping.reference}\n`;
            }
            message += `\n`;
            
            message += `üõçÔ∏è *Productos:*\n`;
            order.items.forEach(item => {
                message += `‚Ä¢ ${item.name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}\n`;
            });
            
            message += `\nüí∞ *Total: $${order.total.toFixed(2)}*\n`;
            message += `üí≥ *M√©todo de pago:* Transferencia Bancaria\n`;
            message += `üè¶ *Bancos disponibles:* Pichincha, Guayaquil, Internacional, Pac√≠fico\n`;
            message += `\n`;
            message += `¬°Gracias por tu pedido! Te contactaremos para coordinar el pago. üéâ`;
            
            return message;
        }

        function getPaymentMethodName(payment) {
            const method = typeof payment === 'string' ? payment : payment.method;
            const methods = {
                'card': 'Tarjeta de Cr√©dito/D√©bito',
                'transfer': 'Transferencia Bancaria',
                'cash': 'Pago Contra Entrega',
                'whatsapp': 'WhatsApp Business'
            };
            return methods[method] || method;
        }

        // Funcionalidad de b√∫squeda desde el carrito
        function setupCartSearch() {
            const cartSearch = document.getElementById('cart-search');
            if (!cartSearch) return;

            cartSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });

            const searchIcon = document.querySelector('.search-icon');
            if (searchIcon) {
                searchIcon.addEventListener('click', function() {
                    const query = cartSearch.value.trim();
                    if (query) {
                        window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                    }
                });
                searchIcon.style.cursor = 'pointer';
            }
        }

        // Funci√≥n para volver a la tienda
        function goBack() {
            window.history.back() || (window.location.href = 'store.html');
        }

        // Funci√≥n para eliminar producto del checkout
        function removeFromCheckout(productId) {
            if (confirm('¬øDeseas eliminar este producto del carrito?')) {
                if (window.StorageAPI) {
                    window.StorageAPI.removeFromCart(productId);
                    
                    // Mostrar notificaci√≥n
                    if (window.Helpers && window.Helpers.showToast) {
                        window.Helpers.showToast('Producto eliminado del carrito', 'success');
                    }
                    
                    // Recargar items del checkout
                    loadCheckoutItems();
                    
                    // Verificar si el carrito est√° vac√≠o
                    const cart = window.StorageAPI.getCart();
                    if (cart.length === 0) {
                        setTimeout(() => {
                            window.location.href = 'store.html';
                        }, 1000);
                    }
                }
            }
        }

        // Funciones de validaci√≥n de tarjeta eliminadas - ya no se requieren

        // ===== FUNCIONALIDAD DEL MODAL DE ASESORES =====
        function openAdvisorsModal() {
            const modal = document.getElementById('advisors-modal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeAdvisorsModal() {
            const modal = document.getElementById('advisors-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function contactAdvisor(email, name) {
            const subject = encodeURIComponent('Consulta desde H&B Importaciones');
            const body = encodeURIComponent(`Hola ${name},\n\nMe gustar√≠a recibir asesor√≠a sobre productos disponibles.\n\nGracias.`);
            const mailtoLink = `mailto:${email}?subject=${subject}&body=${body}`;
            window.open(mailtoLink);
            alert(`Redirigiendo a ${name}`);
        }

        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAdvisorsModal();
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            setupCartSearch();
            loadCheckoutItems();
        });
    </script>

    <!-- Advisors Modal -->
    <div id="advisors-modal" class="advisors-modal">
        <div class="advisors-backdrop" onclick="closeAdvisorsModal()"></div>
        <div class="advisors-panel">
            <div class="advisors-content">
                <div class="advisors-header">
                    <div class="advisors-title-section">
                        <h2>Nuestros Asesores</h2>
                        <p>Elige con qui√©n te gustar√≠a contactar para recibir asesor√≠a personalizada</p>
                        <button class="advisors-close-btn" onclick="closeAdvisorsModal()">
                            √ó
                        </button>
                    </div>
                </div>

                <div class="advisors-grid">
                    <!-- Asesor 1 -->
                    <div class="advisor-card">
                        <div class="advisor-avatar">
                            <img src="https://via.placeholder.com/80x80?text=MR" alt="Mar√≠a Rodr√≠guez" />
                        </div>
                        <div class="advisor-info">
                            <h3>Mar√≠a Rodr√≠guez</h3>
                            <p class="advisor-role">Especialista en Laptops</p>
                            <p class="advisor-description">Experta en equipos port√°tiles y soluciones empresariales</p>
                            <div class="advisor-contact">
                                <span class="advisor-status online">‚óè En l√≠nea</span>
                                <button class="advisor-contact-btn" onclick="contactAdvisor('maria.rodriguez@hbimportaciones.com', 'Mar√≠a Rodr√≠guez')">
                                    Contactar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Asesor 2 -->
                    <div class="advisor-card">
                        <div class="advisor-avatar">
                            <img src="https://via.placeholder.com/80x80?text=CL" alt="Carlos L√≥pez" />
                        </div>
                        <div class="advisor-info">
                            <h3>Carlos L√≥pez</h3>
                            <p class="advisor-role">Especialista en Gaming</p>
                            <p class="advisor-description">Conoce todo sobre equipos gaming y componentes de alta gama</p>
                            <div class="advisor-contact">
                                <span class="advisor-status online">‚óè En l√≠nea</span>
                                <button class="advisor-contact-btn" onclick="contactAdvisor('carlos.lopez@hbimportaciones.com', 'Carlos L√≥pez')">
                                    Contactar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Asesor 3 -->
                    <div class="advisor-card">
                        <div class="advisor-avatar">
                            <img src="https://via.placeholder.com/80x80?text=AM" alt="Ana Mart√≠nez" />
                        </div>
                        <div class="advisor-info">
                            <h3>Ana Mart√≠nez</h3>
                            <p class="advisor-role">Especialista en Componentes</p>
                            <p class="advisor-description">Experta en CPUs, GPUs y componentes de computadoras</p>
                            <div class="advisor-contact">
                                <span class="advisor-status busy">‚óè Ocupada</span>
                                <button class="advisor-contact-btn" onclick="contactAdvisor('ana.martinez@hbimportaciones.com', 'Ana Mart√≠nez')">
                                    Contactar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Asesor 4 -->
                    <div class="advisor-card">
                        <div class="advisor-avatar">
                            <img src="https://via.placeholder.com/80x80?text=DG" alt="Diego Garc√≠a" />
                        </div>
                        <div class="advisor-info">
                            <h3>Diego Garc√≠a</h3>
                            <p class="advisor-role">Especialista en Monitores</p>
                            <p class="advisor-description">Conoce las mejores opciones en monitores y displays</p>
                            <div class="advisor-contact">
                                <span class="advisor-status online">‚óè En l√≠nea</span>
                                <button class="advisor-contact-btn" onclick="contactAdvisor('diego.garcia@hbimportaciones.com', 'Diego Garc√≠a')">
                                    Contactar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>