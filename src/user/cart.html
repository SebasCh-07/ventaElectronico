<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - H&B Importaciones</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="site-header">
        <div class="topbar">
            <div class="container topbar-content">
                <span>Lunes a Viernes 09:00 a 18:00 | S√°bados 09:00 a 13:00</span>
                <div class="spacer"></div>
                <span>Bienvenido a H&B Importaciones</span>
                <div class="spacer"></div>
                <a href="#" class="top-link"><span data-icon="location" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Ubicaci√≥n</a>
                <a href="#" class="top-link"><span data-icon="truck" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Rastrear pedido</a>
                <a href="store.html" class="top-link"><span data-icon="store" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Tienda</a>
                <a href="../auth/login.html" class="top-link" id="login-link"><span data-icon="user" style="width:14px;height:14px;display:inline-block;vertical-align:-2px"></span> Mi Cuenta</a>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <div class="header-content">
                    <a class="brand" href="../../index.html">H&B<span class="web-badge">web</span></a>
                    <div class="search">
                        <span class="search-icon" data-icon="search" style="width:18px;height:18px"></span>
                        <input type="text" id="cart-search" placeholder="Buscar productos...">
                    </div>
                    <div class="header-icons">
                        <a href="#" class="icon-btn">
                            <span class="icon" data-icon="compare" style="width:16px;height:16px"></span>
                            <span class="badge">0</span>
                        </a>
                        <a href="#" class="icon-btn">
                            <span class="icon" data-icon="heart" style="width:16px;height:16px"></span>
                        </a>
                        <a href="cart.html" class="icon-btn">
                            <span class="icon" data-icon="cart" style="width:16px;height:16px"></span>
                            <span class="badge" id="cart-count">0</span>
                            <span class="cart-total" id="cart-total">$0,00</span>
                        </a>
                        <span id="logout-container"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="checkout-container">
        <div class="container">
            <!-- Back Button -->
            <div class="checkout-header">
                <button class="btn secondary back-btn" onclick="goBack()">
                    <span>‚Üê</span>
                    <span>Seguir Comprando</span>
                </button>
                <h1>Finalizar Compra</h1>
            </div>

            <!-- Progress Bar -->
            <div class="checkout-progress">
                <div class="progress-step active">
                    <div class="step-number">1</div>
                    <span>Informaci√≥n</span>
                </div>
                <div class="progress-line active"></div>
                <div class="progress-step active">
                    <div class="step-number">2</div>
                    <span>Pago</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-number">3</div>
                    <span>Confirmaci√≥n</span>
                </div>
            </div>

            <div class="checkout-layout">
                <!-- Left Column - Forms -->
                <div class="checkout-forms">
                    <!-- Contact Information -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <h2>Informaci√≥n de Contacto</h2>
                        </div>
                        <div class="form-grid">
                            <div class="field">
                                <label>Email *</label>
                                <input type="email" id="customer-email" placeholder="tu@email.com" required>
                            </div>
                            <div class="field">
                                <label>Tel√©fono *</label>
                                <input type="tel" id="customer-phone" placeholder="+593 99 999 9999" required>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Information -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <h2>Informaci√≥n de Env√≠o</h2>
                        </div>
                        <div class="form-grid">
                            <div class="field full-width">
                                <label>Nombre Completo *</label>
                                <input type="text" id="shipping-name" placeholder="Juan P√©rez" required>
                            </div>
                            <div class="field">
                                <label>Provincia *</label>
                                <select id="shipping-province" required>
                                    <option value="">Seleccionar provincia</option>
                                    <option value="pichincha">Pichincha</option>
                                    <option value="guayas">Guayas</option>
                                    <option value="azuay">Azuay</option>
                                    <option value="manabi">Manab√≠</option>
                                    <option value="tungurahua">Tungurahua</option>
                                    <option value="el-oro">El Oro</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Ciudad *</label>
                                <input type="text" id="shipping-city" placeholder="Quito" required>
                            </div>
                            <div class="field full-width">
                                <label>Direcci√≥n *</label>
                                <input type="text" id="shipping-address" placeholder="Av. Amazonas y Rep√∫blica, Edificio XYZ" required>
                            </div>
                            <div class="field">
                                <label>C√≥digo Postal</label>
                                <input type="text" id="shipping-postal" placeholder="170150">
                            </div>
                            <div class="field">
                                <label>Referencia</label>
                                <input type="text" id="shipping-reference" placeholder="Cerca del banco">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <h2>M√©todo de Pago</h2>
                        </div>
                        <div class="payment-methods">
                            <div class="payment-option">
                                <input type="radio" id="card" name="payment" value="card" checked>
                                <label for="card">
                                    <div class="payment-icon">üí≥</div>
                                    <div class="payment-info">
                                        <h4>Tarjeta de Cr√©dito/D√©bito</h4>
                                        <p>Pago seguro con tu tarjeta</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Card Details Form -->
                        <div class="card-details-form">
                            <div class="form-grid">
                                <div class="field full-width">
                                    <label>N√∫mero de Tarjeta *</label>
                                    <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                                </div>
                                <div class="field">
                                    <label>Fecha de Vencimiento *</label>
                                    <input type="text" id="card-expiry" placeholder="MM/AA" maxlength="5" required>
                                </div>
                                <div class="field">
                                    <label>CVV *</label>
                                    <input type="text" id="card-cvv" placeholder="123" maxlength="4" required>
                                </div>
                                <div class="field full-width">
                                    <label>Nombre en la Tarjeta *</label>
                                    <input type="text" id="card-name" placeholder="Nombre como aparece en la tarjeta" required>
                                </div>
                            </div>
                            <div class="security-note">
                                <span class="security-icon">üîí</span>
                                <span>Tus datos est√°n protegidos con encriptaci√≥n SSL de 256 bits</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Order Summary -->
                <div class="order-summary">
                    <div class="summary-card">
                        <h3>Resumen del Pedido</h3>
                        
                        <div id="checkout-items" class="checkout-items">
                            <!-- Items will be loaded here -->
                        </div>

                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="checkout-subtotal">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Env√≠o</span>
                            <span id="checkout-shipping">Gratis</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span id="checkout-total">$0.00</span>
                        </div>

                        <button class="btn brand checkout-btn" onclick="processOrder()">
                            Completar Pedido
                        </button>

                        <div class="security-info">
                            <span data-icon="shield" style="width:16px;height:16px"></span>
                            <span>Informaci√≥n segura y protegida</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <small>¬© <span id="year"></span> H&B Importaciones</small>
        </div>
    </footer>

    <script src="../../js/utils/data.js"></script>
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/utils/icons.js"></script>
    <script src="../../js/utils/ui.js"></script>
    <script src="../../js/utils/sticky-header.js"></script>
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Verificar sesi√≥n y actualizar UI
        const sessionData = localStorage.getItem('hb_session');
        if (sessionData) {
            try {
                const session = JSON.parse(sessionData);
                document.getElementById('login-link').style.display = 'none';
                document.getElementById('logout-container').innerHTML = `
                    <button class="btn icon logout" onclick="logout()" title="Cerrar sesi√≥n">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 6H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 16l4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18 12H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                `;
            } catch (e) {
                // Sesi√≥n inv√°lida, mantener login visible
            }
        }

        function logout() {
            localStorage.removeItem('hb_session');
            window.location.href = '../auth/login.html';
        }

        // ===== CHECKOUT FUNCTIONALITY =====
        function loadCheckoutItems() {
            const container = document.getElementById('checkout-items');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const totalEl = document.getElementById('checkout-total');
            
            const cart = window.StorageAPI ? window.StorageAPI.getCart() : [];
            const products = window.StorageAPI ? window.StorageAPI.getProducts() : [];
            
            if (cart.length === 0) {
                window.location.href = 'store.html';
                return;
            }

            // Expandir carrito con informaci√≥n de productos
            const expandedCart = cart.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return null;
                
                return {
                    id: item.productId,
                    productId: item.productId,
                    quantity: item.quantity,
                    name: product.name,
                    price: product.pricePublico || product.price || 0,
                    category: product.category,
                    image: product.image
                };
            }).filter(item => item !== null);

            let subtotal = 0;
            container.innerHTML = expandedCart.map(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                return `
                    <div class="checkout-item" data-product-id="${item.productId}">
                        <div class="item-image">
                            <img src="${item.image || 'https://via.placeholder.com/60x60?text=Producto'}" alt="${item.name}">
                            <span class="item-quantity">${item.quantity}</span>
                        </div>
                        <div class="item-details">
                            <h4>${item.name}</h4>
                            <p>${item.category || 'General'}</p>
                        </div>
                        <div class="item-price">
                            $${itemTotal.toFixed(2)}
                        </div>
                        <div class="item-actions">
                            <button class="btn-remove" onclick="removeFromCheckout('${item.productId}')" title="Eliminar producto">
                                √ó
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            totalEl.textContent = `$${subtotal.toFixed(2)}`;
        }

        function processOrder() {
            // Validar formulario
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const name = document.getElementById('shipping-name').value;
            const province = document.getElementById('shipping-province').value;
            const city = document.getElementById('shipping-city').value;
            const address = document.getElementById('shipping-address').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;

            if (!email || !phone || !name || !province || !city || !address) {
                if (window.Helpers && window.Helpers.showToast) {
                    window.Helpers.showToast('Por favor completa todos los campos obligatorios', 'warning');
                } else {
                    alert('Por favor completa todos los campos obligatorios');
                }
                return;
            }

            // Validar datos de tarjeta
            const cardValidation = validateCardData();
            if (!cardValidation.valid) {
                if (window.Helpers && window.Helpers.showToast) {
                    window.Helpers.showToast(cardValidation.message, 'error');
                } else {
                    alert(cardValidation.message);
                }
                return;
            }

            // Crear objeto del pedido
            const cart = window.StorageAPI ? window.StorageAPI.getCart() : [];
            const products = window.StorageAPI ? window.StorageAPI.getProducts() : [];
            
            // Expandir carrito con informaci√≥n de productos
            const expandedCart = cart.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return null;
                
                return {
                    id: item.productId,
                    productId: item.productId,
                    quantity: item.quantity,
                    name: product.name,
                    price: product.pricePublico || product.price || 0,
                    category: product.category,
                    image: product.image
                };
            }).filter(item => item !== null);
            
            const total = expandedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Obtener datos de tarjeta
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvv = document.getElementById('card-cvv').value;
            const cardName = document.getElementById('card-name').value;
            
            const order = {
                id: 'ORD-' + Date.now(),
                date: new Date().toISOString(),
                customer: { email, phone, name },
                shipping: { 
                    province, 
                    city, 
                    address, 
                    postal: document.getElementById('shipping-postal').value,
                    reference: document.getElementById('shipping-reference').value
                },
                payment: {
                    method: payment,
                    card: {
                        number: '****-****-****-' + cardNumber.slice(-4), // Solo √∫ltimos 4 d√≠gitos por seguridad
                        expiry: cardExpiry,
                        name: cardName,
                        // NO guardamos CVV por seguridad
                    }
                },
                items: expandedCart,
                total: total,
                status: 'pending'
            };

            // Guardar pedido usando StorageAPI
            if (window.StorageAPI) {
                const orders = window.StorageAPI.getOrders();
                orders.push(order);
                window.StorageAPI.setOrders(orders);
                
                // Limpiar carrito
                window.StorageAPI.clearCart();
            }

            // Mostrar confirmaci√≥n
            if (window.Helpers && window.Helpers.showToast) {
                window.Helpers.showToast('¬°Pago procesado exitosamente! Tu pedido ha sido confirmado.', 'success');
            }

            // Generar mensaje para WhatsApp
            const whatsappMessage = generateWhatsAppMessage(order);
            
            setTimeout(() => {
                if (confirm('¬øDeseas enviar los detalles del pedido por WhatsApp?')) {
                    window.open(`https://wa.me/593994846405?text=${encodeURIComponent(whatsappMessage)}`, '_blank');
                }
                window.location.href = 'store.html';
            }, 2000);
        }

        function generateWhatsAppMessage(order) {
            let message = `üõí *NUEVO PEDIDO - H&B Importaciones*\n\n`;
            message += `üìã *Pedido:* ${order.id}\n`;
            message += `üìÖ *Fecha:* ${new Date(order.date).toLocaleDateString()}\n\n`;
            
            message += `üë§ *Cliente:*\n`;
            message += `‚Ä¢ Nombre: ${order.customer.name}\n`;
            message += `‚Ä¢ Email: ${order.customer.email}\n`;
            message += `‚Ä¢ Tel√©fono: ${order.customer.phone}\n\n`;
            
            message += `üìç *Direcci√≥n de Env√≠o:*\n`;
            message += `‚Ä¢ ${order.shipping.address}\n`;
            message += `‚Ä¢ ${order.shipping.city}, ${order.shipping.province}\n`;
            if (order.shipping.reference) {
                message += `‚Ä¢ Referencia: ${order.shipping.reference}\n`;
            }
            message += `\n`;
            
            message += `üõçÔ∏è *Productos:*\n`;
            order.items.forEach(item => {
                message += `‚Ä¢ ${item.name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}\n`;
            });
            
            message += `\nüí∞ *Total: $${order.total.toFixed(2)}*\n`;
            message += `üí≥ *M√©todo de pago:* ${getPaymentMethodName(order.payment)}\n`;
            if (order.payment.card) {
                message += `üí≥ *Tarjeta:* ${order.payment.card.number} (${order.payment.card.name})\n`;
            }
            message += `\n`;
            message += `¬°Gracias por tu compra! üéâ`;
            
            return message;
        }

        function getPaymentMethodName(payment) {
            const method = typeof payment === 'string' ? payment : payment.method;
            const methods = {
                'card': 'Tarjeta de Cr√©dito/D√©bito',
                'transfer': 'Transferencia Bancaria',
                'cash': 'Pago Contra Entrega',
                'whatsapp': 'WhatsApp Business'
            };
            return methods[method] || method;
        }

        // Funcionalidad de b√∫squeda desde el carrito
        function setupCartSearch() {
            const cartSearch = document.getElementById('cart-search');
            if (!cartSearch) return;

            cartSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });

            const searchIcon = document.querySelector('.search-icon');
            if (searchIcon) {
                searchIcon.addEventListener('click', function() {
                    const query = cartSearch.value.trim();
                    if (query) {
                        window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                    }
                });
                searchIcon.style.cursor = 'pointer';
            }
        }

        // Funci√≥n para volver a la tienda
        function goBack() {
            window.history.back() || (window.location.href = 'store.html');
        }

        // Funci√≥n para eliminar producto del checkout
        function removeFromCheckout(productId) {
            if (confirm('¬øDeseas eliminar este producto del carrito?')) {
                if (window.StorageAPI) {
                    window.StorageAPI.removeFromCart(productId);
                    
                    // Mostrar notificaci√≥n
                    if (window.Helpers && window.Helpers.showToast) {
                        window.Helpers.showToast('Producto eliminado del carrito', 'success');
                    }
                    
                    // Recargar items del checkout
                    loadCheckoutItems();
                    
                    // Verificar si el carrito est√° vac√≠o
                    const cart = window.StorageAPI.getCart();
                    if (cart.length === 0) {
                        setTimeout(() => {
                            window.location.href = 'store.html';
                        }, 1000);
                    }
                }
            }
        }

        // Funciones de validaci√≥n de tarjeta
        function setupCardValidation() {
            const cardNumberInput = document.getElementById('card-number');
            const cardExpiryInput = document.getElementById('card-expiry');
            const cardCvvInput = document.getElementById('card-cvv');
            const cardNameInput = document.getElementById('card-name');

            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', formatCardNumber);
                cardNumberInput.addEventListener('keypress', onlyNumbers);
            }

            if (cardExpiryInput) {
                cardExpiryInput.addEventListener('input', formatCardExpiry);
                cardExpiryInput.addEventListener('keypress', onlyNumbers);
            }

            if (cardCvvInput) {
                cardCvvInput.addEventListener('input', formatCardCvv);
                cardCvvInput.addEventListener('keypress', onlyNumbers);
            }

            if (cardNameInput) {
                cardNameInput.addEventListener('input', formatCardName);
            }
        }

        function formatCardNumber(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || '';
            e.target.value = formattedInputValue;
        }

        function formatCardExpiry(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        }

        function formatCardCvv(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        }

        function formatCardName(e) {
            e.target.value = e.target.value.toUpperCase();
        }

        function onlyNumbers(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
            }
        }

        function validateCardData() {
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvv = document.getElementById('card-cvv').value;
            const cardName = document.getElementById('card-name').value;

            // Validar n√∫mero de tarjeta (16 d√≠gitos)
            if (cardNumber.length !== 16) {
                return { valid: false, message: 'El n√∫mero de tarjeta debe tener 16 d√≠gitos' };
            }

            // Validar fecha de vencimiento
            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                return { valid: false, message: 'Formato de fecha inv√°lido (MM/AA)' };
            }

            const [month, year] = cardExpiry.split('/');
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear() % 100;
            const currentMonth = currentDate.getMonth() + 1;

            if (parseInt(month) < 1 || parseInt(month) > 12) {
                return { valid: false, message: 'Mes inv√°lido' };
            }

            if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                return { valid: false, message: 'La tarjeta est√° vencida' };
            }

            // Validar CVV (3 o 4 d√≠gitos)
            if (cardCvv.length < 3 || cardCvv.length > 4) {
                return { valid: false, message: 'CVV debe tener 3 o 4 d√≠gitos' };
            }

            // Validar nombre
            if (cardName.length < 2) {
                return { valid: false, message: 'Nombre en la tarjeta es requerido' };
            }

            return { valid: true };
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            setupCartSearch();
            loadCheckoutItems();
            setupCardValidation();
        });
    </script>
</body>
</html>